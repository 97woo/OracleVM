# ⚠️ BTC 가격 정밀도 문제 및 해결방안

## 테스트 결과 요약

### 1. **부동소수점(f64) 정밀도 문제 확인**

#### 기본 연산 오차
```
0.1 + 0.2 = 0.30000000000000004441 (예상: 0.3)
```

#### BTC 가격에서의 정밀도 손실
```
BTC price: 65432.12345678899873746559
+ 0.000000001 (1 satoshi)
= 65432.12345678999554365873
차이: 0.00000000099680619314
```

#### 큰 금액 + 작은 수수료
```
100,000,000 + 0.00001 = 100000000.0000099987
```

### 2. **누적 오차 문제**
1000번의 거래 후:
- 예상: -0.001
- 실제: -0.00100000000000875712
- 누적 오차: 0.00000000000000875710

### 3. **거래소 가격 평균 계산**
3개 거래소 가격 평균:
- f64: 65432.12345678899873746559
- Decimal: 65432.123456789
- 차이: 0.000000000001262534409785

## 🚨 실제 금전적 손실 시나리오

### 1. **소액 거래 무시**
```rust
let btc_price = 65432.123456789;  // $65,432
let dust = 0.000000001;            // 1 satoshi ≈ $0.0006
// f64로는 이 변화가 무시될 수 있음
```

### 2. **대량 거래시 오차 누적**
- 일일 10,000건 거래
- 건당 0.00000001 BTC 오차
- 연간: 0.0365 BTC 손실 가능 (≈ $2,400)

### 3. **반올림 방향 문제**
```rust
// 사용자에게 불리한 반올림
65432.123456785 → 65432.12345678  // 손실
65432.123456784 → 65432.12345678  // 손실
```

## ✅ 권장 해결방안

### 1. **정수 기반 처리 (최우선 권장)**
```rust
// 모든 가격을 satoshi 단위로 저장
pub struct BtcPrice {
    satoshis: u64,  // 1 BTC = 100,000,000 satoshis
}

// 계산은 정수로, 표시만 소수로
let price_satoshis = 6543212345678u64;
let display_btc = price_satoshis as f64 / 100_000_000.0;
```

### 2. **Decimal 라이브러리 사용**
```rust
use rust_decimal::Decimal;

let price = Decimal::from_str("65432.123456789").unwrap();
let fee = Decimal::from_str("0.00001").unwrap();
let total = price + fee;  // 정확한 계산
```

### 3. **구현 예시**
```rust
// crates/oracle-node/src/precision_test.rs 참조
pub mod safe_price {
    pub struct BtcPrice {
        satoshis: u64,
    }
    
    impl BtcPrice {
        pub fn from_btc_str(btc: &str) -> Result<Self, String> {
            // Decimal로 파싱 후 satoshi로 변환
        }
    }
}
```

## 📋 체크리스트

- [ ] 모든 BTC 가격을 satoshi(u64)로 저장
- [ ] 외부 API 응답을 즉시 정수로 변환
- [ ] 표시용으로만 f64 사용
- [ ] 가격 비교는 정수로 수행
- [ ] 테스트에 정밀도 검증 포함

## 🔍 추가 테스트 필요 항목

1. 극단적 가격 (0.00000001 BTC, 1,000,000 BTC)
2. 연속적인 소액 거래
3. 다양한 거래소 가격 차이
4. 옵션 정산 가격 계산

## 결론

**현재 f64 사용은 금전적 손실을 야기할 수 있습니다.**
모든 가격 처리를 satoshi 단위의 정수로 변경하는 것을 강력히 권장합니다.